---
title: "Working with tidycensus: Automating Census Data Retrieval"
author: "Ryan Zomorrodi"
brand: brand/presentation.yml
format: 
  revealjs:
    theme: [default, styles.scss]
---

## Learning Objectives

- Locate Census variables and tables
- Use the tidycensus package to interact with the Census API
- Process Census data into a GIS-friendly format

## Why use R to retrieve Census data?

- The Census's official website ([data.census.gov](https://data.census.gov)) is hard to navigate.
- You may need to pull the same data over and over again.
- It's reproducable and provides a data trail.
- It can easily integrate with your GIS workflow.

## Application Programming Interface (API)

- An API is simply a way for things to communicate with each other! 
- In our case, we will be utilizing web APIs.
- You can send utilize web API requests to retrieve data from a repository.
- **Note:** Each request utilizes the sender's server resources. Be kind!

## R API Clients

- R is a programming language with an active community of 
  developers publishing packages
- Many of these packages are aimed at retrieving data
- Examples include:
    - `arcgislayers`
    - `socratadata`
    - `findSVI`

## `tidycensus`

- `tidycensus` is an R package designed to create an easy to use
  inteface for interacting with Census API.
- Can also download Census geographies through it's sister package,
  `tigris`.

```r
# install.packages("tidycensus")
library(tidycensus)
library(tigris)
```

## Other helpful R packages

:::: {.columns}

::: {.column width="50%"}
`tidyverse`

A metapackage (package of packages) which provides helpful utilities to keep data "tidy".
:::

::: {.column width="50%"}
`sf`

The major spatial R package. Provides utilities for reading, writing, and analyzing spatial data.
:::

::::

```r
# install.packages(c("tidyverse", "sf"))
library(tidyverse)
library(sf)
```

## Census data

- **American Community Survey (ACS)**
    - More temporally resolved
- **Decennial Census**
    - More geographically resolved 
    - More variables

## Finding relevant data - ACS

[Census Reporter](https://censusreporter.org/) - Great resource for ACS data

::: {layout-ncol=2}
![](photos/cr_home.png)

![](photos/cr_topics.png)
:::

## Finding relevant data - Decennial

- Several tables to look through
    - Census website provides [documentation](https://www.census.gov/programs-surveys/decennial-census/data-products.2020.html#list-tab-1049675826.html) summarizing the 2020 Decennial Census Products.
- `tidycensus` can help you comb through these tables 

## Finding relevant data

- `load_variables()`
    - Provide a `year` and the name of the table
- table names include
    - `"acs5"` - 5-year ACS
    - `"dhc"` - Demographic and Housing Characteristics
    - `"dp"` - Demographic Profiles

## Examples

```r
load_variables(2023, "acs5")
load_variables(2023, "acs1")
load_variables(2020, "dp")
load_variables(2020, "dhc")
```

## Retriving data

- `get_acs` or `get_decennial()` - The main `tidycensus` functions
- Most `get_*` function calls will provide a:
    - `geography` - ex: `"tract"`
    - `year` - ex: `2020`
    - `variables` or `table` - ex: `"B01001_001"` or `"B01001"`
    - `state` - ex: "IL"

## Examples

```r
get_acs(
  geography = "county",
  year = 2023,
  variables = "B01001_001"
)
```

## Examples {auto-animate="true"}

```{.r code-line-numbers="2|3|4"}
get_acs(
  geography = "county",
  year = 2023,
  variables = "B01001_001"
)
```
## Examples {auto-animate="true"}

```{.r code-line-numbers="2,5"}
get_acs(
  geography = "tract",
  year = 2023,
  variables = "B01001_001",
  state = "IL"
)
```

## Examples {auto-animate="true"}

```{.r code-line-numbers="4"}
get_acs(
  geography = "tract",
  year = 2023,
  variables = c("B01001_001", "B01001_002"),
  state = "IL"
)
```

## Examples {auto-animate="true"}

```{.r code-line-numbers="4"}
get_acs(
  geography = "tract",
  year = 2023,
  table = "B01001"
  state = "IL"
)
```

## Examples {auto-animate="true"}

```{.r code-line-numbers="1,3-5,7"}
get_decennial(
  geography = "tract",
  year = 2020,
  table = "DP1",
  sumfile = "dp",
  state = "IL"
)
```

## Retrieving geographies

- The `get_*` functions can also retrieve cartographic boundaries too.
    - Simply add `geometry = TRUE`
- You can separately get boundaries with the `tigris` functions:
    - `counties()`, `tracts()`, `block_groups()`, `blocks()`

## Examples

```{.r code-line-numbers="1,6,7|10-11|12-13"}
# attaches cartographic geometry to your acs data
get_acs(
  geography = "county",
  year = 2023,
  variables = "B01001_001",
  output = "wide",
  geometry = TRUE
)

# retrieves cartographic geometry
tigris::counties(state = "IL", cb = TRUE, year = 2023)
# retrieves TIGER geometry
tigris::tracts(state = "IL", cb = FALSE, year = 2023)
```

## Producing derivative estimates

- The Census may provide estimates in a form than you require
    - Ex: counts when you need rates or subgrouped data when you need a large group
- It may be self explanatory to add, multiply, or divide your estimate into a new estimate, but how do you calculate margins or errors?

## Producing derivative estimates

- `tidycensus` provides you with `moe_*` functions which can help you solve this problem.
- `moe_*` functions are built to be easy to use with `tidyverse` functionality.

## Examples

```r
get_acs(
  geography = "tract",
  variables = c(male_u5 = "B01001_003", male_5to9 = "B01001_004"),
  year = 2023,
  state = "IL"
) |>
  group_by(GEOID) |>
  summarize(
    male_u10 = sum(estimate),
    male_u10_moe = moe_sum(moe, estimate)
  )
```

## Examples

```{.r code-line-numbers="10"}
get_acs(
  geography = "tract",
  variables = c(male_u5 = "B01001_003", male_5to9 = "B01001_004"),
  year = 2023,
  state = "IL"
) |>
  group_by(GEOID) |>
  summarize(
    male_u10 = sum(estimate),
    male_u10_moe = moe_sum(moe, estimate)
  )
```

## Examples

```r
get_acs(
  geography = "tract",
  variables = c(tot_pop = "B01001_001", male_u5 = "B01001_003"),
  year = 2023,
  state = "IL",
  output = "wide"
) |>
  mutate(
    male_u5_pct = male_u5E / tot_popM,
    male_u5_pct_moe = moe_prop(male_u5E, tot_popE, male_u5M, tot_popM)
  )
```
## Examples

```{.r code-line-numbers="10"}
get_acs(
  geography = "tract",
  variables = c(tot_pop = "B01001_001", male_u5 = "B01001_003"),
  year = 2023,
  state = "IL",
  output = "wide"
) |>
  mutate(
    male_u5_pct = male_u5E / tot_popM,
    male_u5_pct_moe = moe_prop(male_u5E, tot_popE, male_u5M, tot_popM)
  )
```

# Let's write some code!